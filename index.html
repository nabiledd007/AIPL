<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Postural Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }
        canvas {
            z-index: 2;
        }
        #navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .nav-item {
            color: #4b5563;
            font-size: 24px;
            padding: 10px;
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            transform: scale(1.2);
            color: #3b82f6;
        }
        .nav-item.active {
            color: #3b82f6;
            transform: scale(1.1);
        }
        #analysis {
            position: fixed;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        #reportView {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f1f5f9;
            padding: 20px;
            overflow-y: auto;
            z-index: 3;
        }
        #report {
            max-width: 800px;
            margin-top:0px;
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        #chartButtons {
            flex: 0 0 auto;
            margin-bottom: 20px;
        }
        #postureChart {
            flex: 1;
margin-top:100px;
            width: 100%;
            max-height: 400px;
        }
        .chart-tab {
            transition: all 0.3s ease;
        }
        .chart-tab.active {
            background: #3b82f6;
            color: white;
            border-radius: 8px;
        }
        .chart-tab:hover {
            background: #93c5fd;
            color: white;
        }
        button {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        @media (max-width: 768px) {
            #report {
                width: 100%;
            }
            #analysis {
                font-size: 14px;
            }
            #postureChart {
                max-height: 300px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="analysis" class="hidden">
        <p class="text-gray-700">Postural Analysis: <span id="postureStatus">Waiting for analysis...</span></p>
    </div>
    <div id="reportView" class="hidden">

<div id="chartButtons" class="flex gap-2 mb-4 flex-wrap">
                <button onclick="loadReport('pie')" class="chart-tab px-4 py-2 bg-gray-200 text-gray-700" id="pieTab">Pie</button>
                <button onclick="loadReport('bar')" class="chart-tab px-4 py-2 bg-gray-200 text-gray-700" id="barTab">Bar</button>
                <button onclick="loadReport('line')" class="chart-tab px-4 py-2 bg-gray-200 text-gray-700" id="lineTab">Line</button>
                <button onclick="loadReport('scatter')" class="chart-tab px-4 py-2 bg-gray-200 text-gray-700" id="scatterTab">Scatter</button>
                <button onclick="exportToPDF()" class="bg-red-500 text-white px-4 py-2 hover:bg-red-600">Export to PDF</button>
            
    </div>
        <div id="report">
          
    </div>
            <canvas id="postureChart"></canvas>
        </div>
    <div id="navbar">
        <i class="fas fa-home nav-item active" onclick="showView('analyse')" id="analyseTab"></i>
        <i class="fas fa-chart-line nav-item" onclick="showView('report')" id="reportTab"></i>
        <i class="fas fa-play nav-item" onclick="startAnalysis()" id="startAnalysisTab"></i>
        <i class="fas fa-camera-rotate nav-item" onclick="switchCamera()" id="switchCameraTab"></i>
        <i class="fas fa-save nav-item" onclick="saveData()" id="saveDataTab"></i>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const postureStatus = document.getElementById('postureStatus');
        const analysisDiv = document.getElementById('analysis');
        const reportView = document.getElementById('reportView');
        let latestPostureData = {};
        let postureChart = null;
        let latestChartData = null;
        let currentFacingMode = 'environment'; // Default to back camera

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqfAtBZ1ObZfzTaaB7EB3sNHJJ3W_zXJQUKiMWzoDcjt8ramwos4_gPd3cwpi8n7eL/exec';

        // Initialize MediaPipe Pose
        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
        });
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);

        // Initialize camera
        let camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({ image: videoElement });
            },
            width: 1280,
            height: 720,
            facingMode: currentFacingMode
        });

        function startAnalysis() {
            camera.start();
            postureStatus.textContent = 'Analyzing posture...';
            analysisDiv.classList.remove('hidden');
            // Set canvas size to match video
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }

        async function switchCamera() {
            try {
                await camera.stop();
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await pose.send({ image: videoElement });
                    },
                    width: 1280,
                    height: 720,
                    facingMode: currentFacingMode
                });
                await camera.start();
                postureStatus.textContent = `Analyzing posture (${currentFacingMode === 'environment' ? 'Back' : 'Front'} camera)...`;
            } catch (error) {
                alert('Error switching camera: ' + error.message);
            }
        }

        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawLandmarks(results.poseLandmarks);
                analyzePosture(results.poseLandmarks);
            }
        }

        function drawLandmarks(landmarks) {
            canvasCtx.strokeStyle = 'red';
            canvasCtx.lineWidth = 2;
            for (const landmark of landmarks) {
                canvasCtx.beginPath();
                canvasCtx.arc(landmark.x * canvasElement.width, landmark.y * canvasElement.height, 5, 0, 2 * Math.PI);
                canvasCtx.fillStyle = 'red';
                canvasCtx.fill();
            }
            const connections = [[11, 12], [11, 13], [12, 14], [23, 24]];
            canvasCtx.strokeStyle = 'green';
            canvasCtx.lineWidth = 10;
            for (const [start, end] of connections) {
                canvasCtx.beginPath();
                canvasCtx.moveTo(landmarks[start].x * canvasElement.width, landmarks[start].y * canvasElement.height);
                canvasCtx.lineTo(landmarks[end].x * canvasElement.width, landmarks[end].y * canvasElement.height);
                canvasCtx.stroke();
            }
        }

        function analyzePosture(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const shoulderMidpointX = (leftShoulder.x + rightShoulder.x) / 2;
            const shoulderMidpointY = (leftShoulder.y + rightShoulder.y) / 2;
            const forwardHeadDistance = Math.abs(nose.x - shoulderMidpointX);
            const shoulderAlignment = Math.abs(leftShoulder.y - rightShoulder.y);
            let status = 'Good posture';
            if (forwardHeadDistance > 0.1) {
                status = 'Forward head detected! Try aligning your head with your shoulders.';
            }
            if (shoulderAlignment > 0.05) {
                status += '\nUneven shoulders detected! Try leveling your shoulders.';
            }
            postureStatus.innerText = status;
            latestPostureData = { forwardHeadDistance, shoulderAlignment, userId: 'user1' };
        }

        async function saveData() {
            if (!latestPostureData.forwardHeadDistance) {
                alert('No posture data to save. Start analysis first.');
                return;
            }
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(latestPostureData)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Data saved to Google Sheets!');
                } else {
                    alert('Error saving data: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadReport(chartType = 'line') {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                if (data.status === 'error') {
                    alert('Error loading data: ' + data.message);
                    return;
                }
                const labels = data.map(row => new Date(row.timestamp).toLocaleString());
                const forwardHeadData = data.map(row => row.forwardHeadDistance);
                const shoulderAlignmentData = data.map(row => row.shoulderAlignment);
                latestChartData = { labels, forwardHeadData, shoulderAlignmentData };

                ['pieTab', 'barTab', 'lineTab', 'scatterTab'].forEach(tab => {
                    document.getElementById(tab).classList.remove('active');
                });
                document.getElementById(`${chartType}Tab`).classList.add('active');

                reportView.classList.remove('hidden');
                const ctx = document.getElementById('postureChart').getContext('2d');

                if (postureChart) {
                    postureChart.destroy();
                }

                const config = {
                    data: {
                        labels: chartType === 'pie' ? ['Forward Head', 'Shoulder Alignment'] : labels,
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Posture Trends', font: { size: 18 } }
                        }
                    }
                };

                if (chartType === 'pie') {
                    config.type = 'pie';
                    const latestData = data[data.length - 1] || {};
                    config.data.datasets = [{
                        data: [latestData.forwardHeadDistance || 0, latestData.shoulderAlignment || 0],
                        backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(236, 72, 153, 0.8)']
                    }];
                    config.options.plugins.legend = { position: 'top' };
                } else {
                    config.data.datasets = [
                        {
                            label: 'Forward Head Distance',
                            data: forwardHeadData,
                            borderColor: 'rgba(59, 130, 246, 0.8)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: chartType === 'line' || chartType === 'bar',
                            tension: chartType === 'line' ? 0.4 : 0
                        },
                        {
                            label: 'Shoulder Alignment Difference',
                            data: shoulderAlignmentData,
                            borderColor: 'rgba(236, 72, 153, 0.8)',
                            backgroundColor: 'rgba(236, 72, 153, 0.2)',
                            fill: chartType === 'line' || chartType === 'bar',
                            tension: chartType === 'line' ? 0.4 : 0
                        }
                    ];
                    config.options.scales = {
                        y: { beginAtZero: true, title: { display: true, text: 'Distance (Normalized)' } },
                        x: { title: { display: true, text: 'Timestamp' } }
                    };
                    config.type = chartType === 'scatter' ? 'scatter' : chartType;
                    if (chartType === 'scatter') {
                        config.data.datasets.forEach(dataset => {
                            dataset.pointRadius = 5;
                            dataset.pointBackgroundColor = dataset.borderColor;
                        });
                    }
                }

                postureChart = new Chart(ctx, config);
            } catch (error) {
                alert('Error loading report: ' + error.message);
            }
        }

        function exportToPDF() {
            if (!postureChart || !latestChartData) {
                alert('No chart data available. Load a report first.');
                return;
            }
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Posture Analysis Report', 20, 20);

            const chartCanvas = document.getElementById('postureChart');
            const chartDataUrl = chartCanvas.toDataURL('image/png');
            doc.addImage(chartDataUrl, 'PNG', 20, 30, 170, 100);

            doc.setFontSize(12);
            doc.text('Latest Posture Metrics:', 20, 140);
            doc.text(`Forward Head Distance: ${latestPostureData.forwardHeadDistance || 'N/A'}`, 20, 150);
            doc.text(`Shoulder Alignment: ${latestPostureData.shoulderAlignment || 'N/A'}`, 20, 160);
            doc.text(`Status: ${postureStatus.innerText}`, 20, 170);

            doc.save(`Posture_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function showView(view) {
            document.getElementById('analyseTab').classList.remove('active');
            document.getElementById('reportTab').classList.remove('active');
            document.getElementById(`${view}Tab`).classList.add('active');

            analysisDiv.classList.add('hidden');
            reportView.classList.add('hidden');

            if (view === 'analyse') {
                analysisDiv.classList.remove('hidden');
            } else {
                reportView.classList.remove('hidden');
                loadReport('pie');
            }
        }
    </script>
</body>
</html>
